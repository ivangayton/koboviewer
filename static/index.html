<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" type="text/css" href="static/leaflet.css">
<style>
    body { margin: 0; font-family: helvetica; }
    #map { width: 100%; height: 100%; }
    #status, #sync {
      position: absolute;
      left: 0;
      bottom: 0;
      margin: 6px;
      padding: 6px;
      font-size: 14px;
      z-index: 1000;
    }
    #status {
      border: 1px solid #999;
      background: #fff;
      background-image: url('static/loading.gif');
      background-repeat: no-repeat;
      background-position: 2px 2px;
      padding-left: 28px;
    }
    #locate {
      position: absolute;
      right: 10px;
      bottom: 24px;
      width: 30px;
      height: 30px;
      background: #fff;
      border: 2px solid rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      z-index: 1000;
      -webkit-tap-highlight-color: rgba(51, 181, 229, 0.4);
    }
    #locate:hover { background: #f4f4f4; }
    #locate img { margin: 3px; }
    #times {
      position: absolute;
      right: 0;
      top: 0;
      margin: 6px;
      padding: 6px;
      border: 1px solid #999;
      background: #fff;
      font-size: 14px;
      z-index: 1000;
    }
</style>
<script src="static/jquery-3.2.1.min.js"></script>
<script src="static/leaflet.js"></script>
<script src="static/config.js"></script>
<script src="static/koboviewer.js"></script>

<div id="map"></div>
<div id="status"></div>
<div id="sync"><button>Check for new data</button></div>
<div id="locate"><img src="static/locate-24.png"></div>
<div id="times">
  Show data from:
  <select id="min-time">
    <option value="2017-09-11" selected>Sep 11 until now</option>
    <option value="2017-09-10">Sep 10 until now</option>
    <option value="2017-09-09">Sep 9 until now</option>
    <option value="2017-09-08">Sep 8 until now</option>
    <option value="2017-09-07">Sep 7 until now</option>
    <option value="2017-09-06">Sep 6 until now</option>
    <option value="2017-09-05">Sep 5 until now</option>
    <option value="2017-09-04">Sep 4 until now</option>
    <option value="2017-09-03">Sep 3 until now</option>
    <option value="2017-09-02">Sep 2 until now</option>
    <option value="2017-09-01">Sep 1 until now</option>
    <option value="2017-08-31">Aug 31 until now</option>
    <option value="2017-08-30">Aug 30 until now</option>
    <option value="2017-08-29">Aug 29 until now</option>
    <option value="2017-08-28">Aug 28 until now</option>
    <option value="2017-08-27">Aug 27 until now</option>
  </select>
</div>

<script>
  var minTime = '2017-09-11';

  function loadForm(form, callback) {
    var noun = (form.description.match(/drain_point/) ? 'points' :
                form.description.match(/drain_segment/) ? 'segments' :
                'records');
    setStatus('Loading ' + form.description +
              ' (' + form.num_of_submissions + ' ' + noun + ')...');
    syncRecords(form.formid, function() {
      showRecords(map, form.formid, minTime);
      setStatus(null);
      callback();
    });
  }

  $('#min-time').change(function() {
    minTime = $('#min-time').val();
    for (var formId in recordsByFormId) {
      showRecords(map, formId, minTime);
    }
  });

  var map = newOsmMap('map');
  map.setView(L.latLng(-6.764, 39.250), 14);  // Mikocheni
  setStatus('Loading forms...');
  syncForms(function() {
    var seg115 = forms[124];
    var seg114 = forms[119];
    var seg113 = forms[113];
    var seg112 = forms[104];
    var seg111 = forms[85];

    var pt115 = forms[123];
    var pt114 = forms[118];
    var pt113 = forms[114];
    var pt112 = forms[103];
    var pt111 = forms[84];

    loadForm(seg115, function() {
      loadForm(pt115, function() {
        loadForm(seg114, function() {
          loadForm(pt114, function() {
            loadForm(seg113, function() {
              loadForm(pt113, function() {
                return;
                loadForm(seg112, function() {
                  loadForm(pt112, function() {
                    loadForm(seg111, function() {
                      loadForm(pt111, function() {
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    $('#sync').click(function() {
      var fi = 124, form = forms[fi];
      setStatus('Refreshing ' + form.description + '...');
      syncRecords(fi, function() {
        var fi = 124, form = forms[fi];
        showRecords(map, fi, minTime);

        var fi = 123, form = forms[fi];
        setStatus('Refreshing ' + form.description + '...');
        syncRecords(fi, function() {
          var fi = 123, form = forms[fi];
          showRecords(map, fi, minTime);
          setStatus(null);
        });
      });
    });
  });

  var LOCATION_MARKER_STYLE = {
    color: '#0000ff',
    fillColor: '#0000ff',
    fillOpacity: 0.2,
    stroke: true,
    weight: 1,
    radius: 8
  };
  var locationMarker = L.circle(L.latLng(0, 0), LOCATION_MARKER_STYLE);
  var locationUpdateInterval = null;

  var goToPosition = function(e) {
    if (e.coords.accuracy > 100) return;
    var zoom = Math.max(map.getZoom(), 16);
    map.setView(L.latLng(e.coords.latitude, e.coords.longitude), zoom);
    updateLocationMarker(e);
  };

  var updateLocationMarker = function(e) {
    if (e.coords.accuracy > 100) return;
    var zoom = Math.max(map.getZoom(), 16);
    locationMarker.setLatLng(L.latLng(e.coords.latitude, e.coords.longitude));
    locationMarker.setRadius(e.coords.accuracy);
    locationMarker.addTo(map);
  };

  $('#locate').click(function() {
    navigator.geolocation.getCurrentPosition(goToPosition);
    if (!locationUpdateInterval) {
      locationUpdateInterval = setInterval(function() {
        navigator.geolocation.getCurrentPosition(updateLocationMarker);
      }, 1000);
    }
  });
</script>
